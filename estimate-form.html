<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Estimate - Elite Renovation</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/M58mL0J/transparent-elite-home.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f6fa;
        }
        .form-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
            padding: 10px 0;
        }
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-right label {
            font-weight: 500;
            color: #2c3e50;
        }
        .current-date {
            font-size: 16px;
            color: #2c3e50;
            font-weight: 500;
            min-width: 100px;
        }
        .company-logo {
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 3px;
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
        }
        input, select, textarea {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .line-items {
            margin-bottom: 20px;
        }
        .line-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .remove-item {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .add-item {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        button[type="submit"] {
            background: #e74c3c;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            opacity: 0.9;
        }
        .section-title {
            text-align: center;
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 8px;
        }
        .form-section .section-title {
            border-bottom: 2px solid #e74c3c;
        }
        .payment-method-note {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        .company-info-small {
            text-align: left;
            font-size: 0.9em;
            color: #666;
            margin-top: 15px;
            line-height: 1.4;
            padding-left: 20px;
        }
        .company-info-small p {
            margin: 2px 0;
        }
        .company-info-small strong {
            color: #2c3e50;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }

        /* Add print styles */
        @media print {
            body {
                margin: 0;
                padding: 0;
                background: white;
            }

            .form-container {
                box-shadow: none;
                padding: 15px;
                max-width: 210mm; /* A4 width */
            }

            .company-logo {
                max-width: 200px; /* Smaller logo for print */
            }

            .form-header {
                margin-bottom: 15px;
                padding-bottom: 10px;
            }

            .company-info-small {
                margin-top: 10px;
                font-size: 0.8em;
            }

            .form-section {
                margin-bottom: 15px;
                padding: 10px;
            }

            .form-row {
                gap: 10px;
                margin-bottom: 8px;
            }

            .form-group {
                margin-bottom: 8px;
            }

            input, select, textarea {
                padding: 4px;
                font-size: 0.85em;
            }

            textarea {
                min-height: 40px;
            }

            .line-items {
                margin-bottom: 15px;
            }

            .line-item {
                gap: 8px;
                margin-bottom: 8px;
            }

            .add-item, .remove-item {
                display: none; /* Hide interactive buttons in print */
            }

            .payment-instructions {
                margin-top: 15px;
                padding-top: 10px;
            }

            .payment-instructions ul {
                margin-bottom: 10px;
            }

            .payment-instructions ul li {
                font-size: 0.85em;
                margin-bottom: 3px;
            }

            .payment-disclaimer {
                font-size: 0.8em;
                margin-top: 8px;
            }

            button[type="submit"] {
                display: none; /* Hide submit button in print */
            }

            /* Hide any other unnecessary elements */
            .form-section:empty,
            .form-group:empty {
                display: none;
            }

            /* Ensure page breaks don't occur in the middle of sections */
            .form-section {
                page-break-inside: avoid;
            }
        }

        /* Add compact styles for regular view */
        @media screen {
            .form-container {
                max-width: 800px;
            }
        }

        .estimate-number-section {
            margin: 20px 0;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .estimate-number-section .form-group {
            max-width: 300px;
        }

        #gstSection, #chequeSection {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        #gstSection input, #chequeSection input {
            background-color: #fff;
            color: #2c3e50;
            font-weight: 500;
        }

        .note {
            display: block;
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            font-style: italic;
        }

        .payment-instructions .form-group {
            margin-bottom: 15px;
        }

        .payment-instructions input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background-color: #2c3e50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.3s ease;
            position: absolute;
            left: 0;
        }

        .back-button:hover {
            background-color: #34495e;
        }

        .back-button i {
            font-size: 16px;
        }

        .form-title {
            margin: 0;
            text-align: center;
            flex-grow: 0;
            position: relative;
            z-index: 1;
        }

        .payment-group {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .payment-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .payment-row input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .form-section {
            margin: 15px 0;
        }

        select {
            padding: 8px;
            margin-left: 10px;
        }

        .payment-schedule {
            margin: 20px 0;
        }

        .payment-group {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
        }

        .payment-row {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr;
            gap: 10px;
            align-items: center;
        }

        .payment-row input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .payment-row input[type="number"] {
            background-color: #f8f9fa;
        }

        /* Add these styles to the existing CSS */
        .cost-breakdown-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .line-items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .line-items-table thead th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 500;
        }

        .line-items-table tbody td {
            padding: 10px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .line-items-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .line-items-table input:focus {
            border-color: #e74c3c;
            outline: none;
            box-shadow: 0 0 0 2px rgba(231,76,60,0.1);
        }

        .item-total {
            font-weight: 500;
            color: #2c3e50;
        }

        #addItemButton {
            background: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 15px 0;
        }

        #addItemButton:hover {
            background: #c0392b;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(231,76,60,0.2);
        }

        .btn-danger {
            background: #e74c3c;
            border-radius: 4px;
            padding: 5px 10px;
            transition: all 0.2s ease;
        }

        .btn-danger:hover {
            background: #c0392b;
            transform: scale(1.05);
        }

        /* Update the cost breakdown section structure */

        /* Add this style for the select element */
        .modern-select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        .payment-row input[type="number"].ratio {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            text-align: right;
        }

        .payment-row input[type="number"].ratio:invalid {
            border-color: #e74c3c;
            background-color: #fff0f0;
        }

        .payment-row span {
            margin-left: -30px;
            width: 20px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-header">
            <a href="admin-dashboard.html" class="back-button">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <h1 class="form-title">Generate Estimate</h1>
        </div>
        <div class="form-container">
            <div class="form-header">
                <img src="https://i.ibb.co/M58mL0J/transparent-elite-home.png" alt="Elite Renovation Works Logo" class="company-logo">
                <h1 class="section-title">Estimate</h1>
                <div class="company-info-small">
                    <p><strong>Elite Renovation Works</strong></p>
                    <p>Jay | 647-563-1314</p>
                    <p>jay@eliterenovationworks.ca</p>
                    <p>6 Interlacken Way, Markham, ON L3R 5H9</p>
                </div>
            </div>
            
            <form id="estimateForm">
                <label>Estimate #:</label>
                <input type="text" class="form-control" id="estimateNumber" name="estimateNumber" required readonly>
                <!-- Client Information -->
                <div class="form-section">
                    <h2 class="section-title">Client Information</h2>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Client Name:</label>
                            <input type="text" name="clientName" required>
                        </div>
                        <div class="form-group">
                            <label>Phone:</label>
                            <input type="tel" name="clientPhone" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email:</label>
                        <input type="email" name="clientEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Street Address:</label>
                        <input type="text" name="clientStreet" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Unit/Suite:</label>
                            <input type="text" name="clientUnit">
                        </div>
                        <div class="form-group">
                            <label>City:</label>
                            <select name="clientCity" required>
                                <option value="">Select City</option>
                                <option value="Markham">Markham</option>
                                <option value="Richmond Hill">Richmond Hill</option>
                                <option value="North York">North York</option>
                                <option value="Scarborough">Scarborough</option>
                                <option value="Toronto">Toronto</option>
                                <option value="Vaughan">Vaughan</option>
                                <option value="Aurora">Aurora</option>
                                <option value="Newmarket">Newmarket</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" id="otherCityGroup" style="display: none;">
                        <label>Specify City:</label>
                        <input type="text" name="otherCity">
                    </div>
                    <div class="form-group">
                        <label>Postal Code:</label>
                        <input type="text" name="clientPostal" required pattern="[A-Za-z][0-9][A-Za-z] [0-9][A-Za-z][0-9]">
                    </div>
                </div>

                <!-- Project Details -->
                <div class="form-section">
                    <h2 class="section-title">Project Details</h2>
                    <div class="form-group">        
                    </div>
                    <div class="form-group">
                        <label>Project Description:</label>
                        <textarea name="projectDescription" rows="4" required></textarea>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="form-section cost-breakdown-section">
                    <h2 class="section-title">Cost Breakdown</h2>
                    <div class="form-group">
                        <label>Payment Method:</label>
                        <select name="paymentMethod" id="paymentMethod" class="modern-select" onchange="updateTaxCalculation()">
                            <option value="cash">Cash Payment (Tax Free)</option>
                            <option value="cash">E-Transfer (weiye8386@gmail.com) (Tax Free)</option>
                            <option value="regular">Credit Card 3.5% surcharge</option>
                            <option value="regular">Cheque (Please make cheques payable to Elite Renovation Works)</option>
                            <option value="regular">Bank Draft (Please make bank drafts payable to Elite Renovation Works)</option>                        
                        </select>
                    </div>

                    <table class="line-items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="width: 100px;">Qty</th>
                                <th style="width: 120px;">Unit Price</th>
                                <th style="width: 120px;">Amount</th>
                                <th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody id="lineItems">
                            <!-- Existing rows will be added here -->
                        </tbody>
                    </table>

                    <button type="button" class="btn btn-primary" id="addItemButton">
                        <i class="fas fa-plus"></i> Add Line Item
                    </button>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Subtotal:</label>
                            <input type="number" name="subtotal" readonly>
                        </div>
                        <div class="form-group">
                            <label>Discount Type:</label>
                            <select name="discountType" id="discountType" onchange="updateDiscountInput()">
                                <option value="none">No Discount</option>
                                <option value="percentage">Percentage (%)</option>
                                <option value="fixed">Fixed Amount ($)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row" id="discountRow" style="display: none;">
                        <div class="form-group">
                            <label id="discountLabel">Discount Amount:</label>
                            <input type="number" name="discountAmount" value="0" min="0" max="100" step="1" onchange="calculateTotals()">
                        </div>
                        <div class="form-group">
                            <label>After Discount:</label>
                            <input type="number" name="afterDiscount" readonly>
                        </div>
                    </div>
                    <div class="form-group" id="taxSection">
                        <label>HST (13%):</label>
                        <input type="number" name="tax" readonly>
                    </div>
                    <div class="form-group">
                        <label>Total:</label>
                        <input type="number" name="total" readonly>
                    </div>

                    <!-- Update payment schedule section -->
                    <div class="form-section">
                        <label for="paymentCount">Payment Schedule:</label>
                        <select id="paymentCount" name="paymentCount" onchange="updatePaymentSchedule()">
                            <option value="3">Standard 3 Payments (Default)</option>
                            <option value="1">1 Custom Payment</option>
                            <option value="2">2 Custom Payments</option>
                            <option value="3">3 Custom Payments</option>
                        </select>
                    </div>

                    <!-- Default payment schedule with editable fields -->
                    <div id="defaultPayments" class="payment-schedule">
                        <div class="payment-group">
                            <h4>Payment 1</h4>
                            <div class="payment-row">
                                <input type="number" class="ratio" value="40" min="0" max="100" step="1" 
                                       oninput="updateDefaultPayments(this)" data-original="40">
                                <span>%</span>
                                <input type="number" class="amount" readonly>
                                <input type="text" class="description" value="upon signing contract">
                            </div>
                        </div>
                        <div class="payment-group">
                            <h4>Payment 2</h4>
                            <div class="payment-row">
                                <input type="number" class="ratio" value="50" min="0" max="100" step="1"
                                       oninput="updateDefaultPayments(this)" data-original="50">
                                <span>%</span>
                                <input type="number" class="amount" readonly>
                                <input type="text" class="description" value="at 50% project completion" 
                                       id="milestoneInput" oninput="updateMilestoneDisplay(this.value)">
                            </div>
                        </div>
                        <div class="payment-group">
                            <h4>Payment 3</h4>
                            <div class="payment-row">
                                <input type="number" class="ratio" value="10" min="0" max="100" step="1"
                                       oninput="updateDefaultPayments(this)" data-original="10">
                                <span>%</span>
                                <input type="number" class="amount" readonly>
                                <input type="text" class="description" value="upon project completion">
                            </div>
                        </div>
                        <div id="percentageWarning" style="color: #e74c3c; display: none; margin-top: 10px;">
                            ⚠️ Total percentages must add up to exactly 100%
                        </div>
                    </div>

                    <!-- Custom payment container -->
                    <div id="customPayments" style="display: none;">
                        <!-- Dynamic payment fields will be generated here -->
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="cta-button submit-button">
                        Generate Estimate
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://nhcttofusmnzlertxjkq.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5oY3R0b2Z1c21uemxlcnR4amtxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI5NDA2MDYsImV4cCI6MjA0ODUxNjYwNn0.WA6rQWC5ISi5QiWOKbdf3wwrysBSMhEq5Lt_HXEDqEU'
        const { createClient } = supabase
        const supabaseClient = createClient(supabaseUrl, supabaseKey)

        // Generate estimate number function
        function generateEstimateNumber() {
            const now = new Date();
            const ymd = now.toISOString().slice(0,10).replace(/-/g, '');
            const random = Math.floor(1000 + Math.random() * 9000);
            return `EST-${ymd}-${random}`;
        }

        // Initialize estimate number when page loads
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('estimateNumber').value = generateEstimateNumber();
            
            // Correct event listener for Add Item button
            document.getElementById('addItemButton').addEventListener('click', function() {
                addLineItem();
            });
        });

        // Add line item function
        function addLineItem() {
            const lineItems = document.getElementById('lineItems');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" class="form-control item-desc" required></td>
                <td><input type="number" class="form-control quantity" min="0" step="1" value="1" required></td>
                <td><input type="number" class="form-control rate" min="0" step="0.01" value="0.00" required></td>
                <td><span class="item-total">0.00</span></td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeLineItem(this)">×</button>
                </td>
            `;
            lineItems.appendChild(newRow);
            
            // Add event listeners for calculations
            newRow.querySelector('.quantity').addEventListener('input', calculateTotal);
            newRow.querySelector('.rate').addEventListener('input', calculateTotal);
        }

        // Remove line item function
        function removeLineItem(btn) {
            btn.closest('tr').remove();
            calculateTotal();
        }

        // Calculate total function
        function calculateTotal() {
            let subtotal = 0;
            document.querySelectorAll('#lineItems tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.quantity').value) || 0;
                const rate = parseFloat(row.querySelector('.rate').value) || 0;
                const total = qty * rate;
                row.querySelector('.item-total').textContent = total.toFixed(2);
                subtotal += total;
            });
            
            // Update subtotal field
            document.querySelector('[name="subtotal"]').value = subtotal.toFixed(2);
            
            // Trigger full calculations
            calculateTotals();
        }

        // Handle city selection
        const citySelect = document.querySelector('[name="clientCity"]');
        const otherCityGroup = document.getElementById('otherCityGroup');
        const otherCityInput = document.querySelector('[name="otherCity"]');

        citySelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                otherCityGroup.style.display = 'block';
                otherCityInput.required = true;
            } else {
                otherCityGroup.style.display = 'none';
                otherCityInput.required = false;
                otherCityInput.value = '';
            }
        });

        // Format postal code
        const postalInput = document.querySelector('[name="clientPostal"]');
        postalInput.addEventListener('input', function() {
            let value = this.value.toUpperCase();
            value = value.replace(/[^A-Z0-9]/g, '');
            if (value.length > 3) {
                value = value.slice(0, 3) + ' ' + value.slice(3, 6);
            }
            this.value = value;
        });

        // Update tax calculation
        function updateTaxCalculation() {
            const paymentMethod = document.getElementById('paymentMethod').value;
            const taxSection = document.getElementById('taxSection');
            taxSection.style.display = paymentMethod === 'regular' ? 'block' : 'none';
            calculateTotals();
        }

        // Calculate totals
        function calculateTotals() {
            // Get all necessary values
            const subtotal = parseFloat(document.querySelector('[name="subtotal"]').value) || 0;
            const discountType = document.getElementById('discountType').value;
            const discountAmount = parseFloat(document.querySelector('[name="discountAmount"]').value) || 0;
            const paymentMethod = document.getElementById('paymentMethod').value;

            // Validate discount inputs
            if (discountType === 'percentage' && discountAmount > 100) {
                document.querySelector('[name="discountAmount"]').value = 100;
                return calculateTotals();
            }
            if (discountType === 'fixed' && discountAmount > subtotal) {
                document.querySelector('[name="discountAmount"]').value = subtotal;
                return calculateTotals();
            }

            // Calculate after discount
            let afterDiscount = subtotal;
            if (discountType === 'percentage') {
                afterDiscount = subtotal * (1 - discountAmount / 100);
            } else if (discountType === 'fixed') {
                afterDiscount = subtotal - discountAmount;
            }

            // Calculate tax
            const tax = paymentMethod === 'regular' ? afterDiscount * 0.13 : 0;
            const totalAmount = afterDiscount + tax;

            // Update form fields
            document.querySelector('[name="afterDiscount"]').value = afterDiscount.toFixed(2);
            document.querySelector('[name="tax"]').value = tax.toFixed(2);
            document.querySelector('[name="total"]').value = totalAmount.toFixed(2);

            // Force payment updates
            if (document.getElementById('paymentCount').value === '3') {
                calculateDefaultPayments(totalAmount);
            } else {
                validateCustomPayments();
            }
        }

        // Update the form submission handler
        document.getElementById('estimateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                // Validate payment schedule
                if (!validatePaymentsBeforePDF()) {
                    return;
                }
                
                // Get form data
                const formData = new FormData(this);
                
                // Initialize paymentSchedule variable before use
                let paymentSchedule = [];
                
                // Collect payment schedule data based on type
                if (document.getElementById('paymentCount').value === '3') {
                    paymentSchedule = Array.from(document.querySelectorAll('#defaultPayments .payment-group')).map(group => ({
                        percent: parseFloat(group.querySelector('.ratio').value),
                        amount: parseFloat(group.querySelector('.amount').value),
                        description: group.querySelector('.description').value
                    }));
                } else {
                    paymentSchedule = Array.from(document.querySelectorAll('#customPayments .payment-group')).map(group => ({
                        percent: parseFloat(group.querySelector('.ratio').value),
                        amount: parseFloat(group.querySelector('.amount').value),
                        description: group.querySelector('.description').value
                    }));
                }
                
                // Continue with the rest of the form submission...
                
                // Reference is now safe since paymentSchedule is defined
                const estimateData = {
                    estimate_number: document.querySelector('[name="estimateNumber"]').value,
                    client_postal: document.querySelector('[name="clientPostal"]').value.trim(),
                    client_name: document.querySelector('[name="clientName"]').value,
                    client_email: document.querySelector('[name="clientEmail"]').value,
                    client_phone: document.querySelector('[name="clientPhone"]').value,
                    client_address: `${document.querySelector('[name="clientStreet"]').value.trim()}, ${document.querySelector('[name="clientCity"]').value.trim()} ${document.querySelector('[name="clientPostal"]').value.trim()}`,
                    project_description: document.querySelector('[name="projectDescription"]').value,
                    payment_method: document.getElementById('paymentMethod').value,
                    subtotal: parseFloat(document.querySelector('[name="subtotal"]').value),
                    tax: parseFloat(document.querySelector('[name="tax"]').value),
                    total: parseFloat(document.querySelector('[name="total"]').value),
                    line_items: [...document.querySelectorAll('#lineItems tr')].filter(row => 
                        row.querySelector('.item-desc')?.value?.trim() && 
                        parseFloat(row.querySelector('.quantity')?.value || 0) > 0
                    ).map(row => ({
                        description: row.querySelector('.item-desc')?.value?.trim() || '',
                        quantity: parseFloat(row.querySelector('.quantity')?.value || 0),
                        unit_price: parseFloat(row.querySelector('.rate')?.value || 0),
                        amount: parseFloat(row.querySelector('.item-total')?.textContent?.replace(/[^0-9.]/g, '') || 0)
                    })),
                    status: 'pending',
                    discount_type: document.getElementById('discountType').value,
                    discount_amount: parseFloat(document.querySelector('[name="discountAmount"]').value) || 0,
                    after_discount: parseFloat(document.querySelector('[name="afterDiscount"]').value) || 0
                };

                // Make a clean copy without any fields not in the database
                const databaseEstimateData = {
                    estimate_number: estimateData.estimate_number,
                    client_name: estimateData.client_name,
                    client_email: estimateData.client_email,
                    client_phone: estimateData.client_phone,
                    client_address: estimateData.client_address,
                    client_postal: document.querySelector('[name="clientPostal"]').value.trim().replace(/\s+/g, ' '),
                    project_description: estimateData.project_description,
                    payment_method: estimateData.payment_method,
                    subtotal: estimateData.subtotal,
                    tax: estimateData.tax,
                    total: estimateData.total,
                    line_items: estimateData.line_items,
                    status: estimateData.status,
                    discount_type: estimateData.discount_type,
                    discount_amount: estimateData.discount_amount,
                    after_discount: estimateData.after_discount
                };

                // Update the database lookup section
                // Replace the existing check for estimate with this code
                let error;
                try {
                    // Only check for existing estimate if we have a valid estimate number
                    const estimateNumber = document.querySelector('[name="estimateNumber"]').value;
                    
                    if (estimateNumber && estimateNumber.trim() !== '') {
                        // Check if estimate exists
                        const { data: existingEstimate, error: checkError } = await supabaseClient
                            .from('estimates')
                            .select('id')
                            .eq('estimate_number', estimateNumber)
                            .maybeSingle();  // Use maybeSingle instead of single to avoid errors
                        
                        if (checkError) {
                            console.error('Error checking existing estimate:', checkError);
                            throw checkError;
                        }
                        
                        if (existingEstimate) {
                            // Update existing estimate (keep ID out of update data)
                            const { error: updateError } = await supabaseClient
                                .from('estimates')
                                .update(databaseEstimateData)
                                .eq('id', existingEstimate.id);
                                
                            if (updateError) {
                                console.error('Error updating estimate:', updateError);
                                throw updateError;
                            }
                            console.log('Updated existing estimate');
                        } else {
                            // Insert new estimate (let database generate ID)
                            const { error: insertError, data: insertedData } = await supabaseClient
                                .from('estimates')
                                .insert([databaseEstimateData])
                                .select();
                                
                            if (insertError) {
                                console.error('Error inserting estimate:', insertError);
                                throw insertError;
                            }
                            console.log('Inserted new estimate', insertedData);
                        }
                    } else {
                        // No estimate number, always insert new
                        const { error: insertError } = await supabaseClient
                            .from('estimates')
                            .insert([databaseEstimateData]);
                            
                        if (insertError) {
                            console.error('Error inserting estimate:', insertError);
                            throw insertError;
                        }
                        console.log('Inserted new estimate (no number provided)');
                    }
                } catch (dbError) {
                    console.error('Database operation failed:', dbError);
                    throw dbError;
                }

                // Create PDF
                window.jsPDF = window.jspdf.jsPDF;
                const doc = new window.jsPDF({
                    unit: 'mm',
                    format: 'a4',
                    compress: true,
                    lineHeight: 1.4
                });
                
                // Set consistent font
                doc.setFont('helvetica');
                doc.setFontSize(11);
                
                // Add company logo
                const logoUrl = 'https://i.ibb.co/M58mL0J/transparent-elite-home.png';
                
                // Load and add logo
                const img = new Image();
                img.src = logoUrl;
                img.onload = function() {
                    // Add logo with proper scaling
                    const imgWidth = 70;
                    const imgHeight = (img.height * imgWidth) / img.width;
                    doc.addImage(img, 'PNG', 15, 10, imgWidth, imgHeight);
                    
                    // Add ESTIMATE title in center
                    doc.setFontSize(20);
                    doc.setTextColor(44, 62, 80);  // Dark blue color
                    doc.text('ESTIMATE', doc.internal.pageSize.width/2, 20, { align: 'center' });
                    
                    // Add company info in top right
                    doc.setFontSize(9);
                    doc.text([
                        '6 Interlacken Way',
                        'Markham, Ontario L3R 5H9',
                        'Representative: Jay',
                        'Phone: 647-563-1314',
                        'Email: jay@eliterenovationworks.ca',
                    ], doc.internal.pageSize.width - 15, 25, { 
                        align: 'right',
                        lineHeightFactor: 1.5
                    });
                    
                    // Add estimate details with smaller font
                    doc.setFontSize(10);
                    doc.text('Estimate #: ' + document.querySelector('[name="estimateNumber"]').value, 15, imgHeight + 25);
                    doc.text('Date: ' + new Date().toLocaleDateString(), doc.internal.pageSize.width - 15, imgHeight + 25, { align: 'right' });

                    // Add separator line
                    doc.setDrawColor(44, 62, 80);
                    doc.setLineWidth(0.5);
                    doc.line(15, imgHeight + 35, doc.internal.pageSize.width - 15, imgHeight + 35);

                    // Add client info with optimized spacing
                    doc.setFontSize(11);
                    doc.text('Client Details:', 15, imgHeight + 45);
                    doc.setFontSize(10);
                    doc.text([
                        'Name: ' + document.querySelector('[name="clientName"]').value,
                        'Email: ' + document.querySelector('[name="clientEmail"]').value
                    ], 20, imgHeight + 55);
                    doc.text([
                        'Phone: ' + document.querySelector('[name="clientPhone"]').value,
                        'Address: ' + document.querySelector('[name="clientStreet"]').value + ', ' + 
                        document.querySelector('[name="clientCity"]').value + ' ' +
                        document.querySelector('[name="clientPostal"]').value
                    ], doc.internal.pageSize.width/2, imgHeight + 55);
              
                    // Update table position to start earlier
                    doc.autoTable({
                        startY: imgHeight + 80,
                        head: [['Description', 'Quantity', 'Unit Price', 'Amount']],
                        body: [...document.querySelectorAll('#lineItems tr')].map(row => [
                            row.querySelector('.item-desc').value,
                            row.querySelector('.quantity').value,
                            '$' + row.querySelector('.rate').value,
                            '$' + row.querySelector('.item-total').textContent
                        ]),
                        foot: [
                            ['', '', 'Subtotal:', '$' + document.querySelector('[name="subtotal"]').value],
                            ...(document.getElementById('discountType').value !== 'none' ? [
                                [
                                    '', 
                                    '', 
                                    document.getElementById('discountType').value === 'percentage' ?
                                        `Discount (${document.querySelector('[name="discountAmount"]').value}%):` :
                                        'Discount:',
                                    '-$' + (document.querySelector('[name="subtotal"]').value - 
                                        document.querySelector('[name="afterDiscount"]').value).toFixed(2)
                                ],
                                [
                                    '', 
                                    '', 
                                    'After Discount:', 
                                    '$' + document.querySelector('[name="afterDiscount"]').value
                                ]
                            ] : []),
                            ['', '', 'Tax (13%):', '$' + document.querySelector('[name="tax"]').value],
                            ['', '', 'Total:', '$' + document.querySelector('[name="total"]').value]
                        ],
                        theme: 'grid',
                        headStyles: { 
                            fillColor: [44, 62, 80],
                            fontSize: 11,
                            halign: 'center',
                            textColor: [255, 255, 255]
                        },
                        bodyStyles: { 
                            fontSize: 10,
                            lineColor: [200, 200, 200],
                            textColor: [44, 62, 80]
                        },
                        footStyles: { 
                            fillColor: [249, 249, 249],
                            fontSize: 10,
                            fontStyle: 'bold',
                            halign: 'right',
                            textColor: [44, 62, 80]
                        },
                        columnStyles: {
                            0: { cellWidth: 'auto' },
                            1: { cellWidth: 30, halign: 'center' },
                            2: { cellWidth: 40, halign: 'right' },
                            3: { cellWidth: 40, halign: 'right' }
                        }
                    });

                    // Add payment info with improved formatting
                    let finalY = doc.lastAutoTable.finalY + 15;
                    doc.setFontSize(10);
                    doc.setTextColor(44, 62, 80); // Dark blue-grey
                    doc.setFont(undefined, 'normal');
                    doc.text("Payment Method:", 20, finalY);
                    doc.setTextColor(0, 0, 0); // Black
                    doc.text(document.getElementById('paymentMethod').selectedOptions[0].text, 50, finalY);
                    finalY += 5;

                    // Add spacing before payment schedule
                    finalY += 8;
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(44, 62, 80); // Dark blue-grey
                    doc.text("Payment Schedule:", 20, finalY);
                    finalY += 5;

                    // Payment schedule items
                    let currentY = finalY;
                    paymentSchedule.forEach((payment, index) => {
                        doc.setFontSize(9);
                        doc.setTextColor(0, 0, 0); // Black text
                        
                        // Payment number and percentage
                        doc.setFont(undefined, 'normal');
                        doc.text(`• Payment ${index + 1} (${payment.percent}%)`, 20, currentY);
                        
                        // Amount
                        doc.text(payment.amount.toLocaleString('en-US', {
                            style: 'currency',
                            currency: 'USD'
                        }), 70, currentY);
                        
                        // Description
                        const descLines = doc.splitTextToSize(payment.description, 160); // Increased width
                        doc.text(descLines, 22, currentY + 4);
                        
                        currentY += (descLines.length * 4) + 8; // Tighter spacing
                    });

                    // Reduce vertical spacing after payments
                    currentY += 8;

                    // Add disclaimer in red
                    doc.setTextColor(231, 76, 60);  // Set to red for disclaimer
                    doc.text('* This estimate is valid for 15 days from the date of issue.', 20, currentY);
                    doc.setTextColor(0, 0, 0);  // Reset back to black

                    // Start second page
                    doc.addPage();

                    // Add project details header
                    doc.setFontSize(14);
                    doc.setTextColor(44, 62, 80);
                    doc.text('Project Details', 15, 20);

                    // Add project description with word wrapping
                    doc.setFontSize(10);
                    const projectDesc = document.querySelector('[name="projectDescription"]').value;
                    const splitDesc = doc.splitTextToSize(projectDesc, doc.internal.pageSize.width - 30);
                    doc.text(splitDesc, 15, 35);

                    // Update footer position and alignment
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    const pageWidth = doc.internal.pageSize.width;

                    // Add thank you message
                    doc.text('Thank you for choosing Elite Renovation Works!', pageWidth/2, doc.internal.pageSize.height - 10, {
                        align: 'center',
                        fontSize: 9
                    });

                    // Save PDF
                    doc.save(`estimate-${document.querySelector('[name="estimateNumber"]').value}.pdf`);
                    alert('Estimate generated and saved successfully!');
                };
                
                img.onerror = function() {
                    throw new Error('Failed to load company logo');
                };
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate or save estimate. Please try again.');
            }
        });

        // Revert discount type handler changes
        function updateDiscountInput() {
            const discountType = document.getElementById('discountType').value;
            const discountRow = document.getElementById('discountRow');
            const discountLabel = document.getElementById('discountLabel');
            const discountInput = document.querySelector('[name="discountAmount"]');

            if (discountType === 'percentage') {
                discountLabel.textContent = 'Discount %:';
                discountInput.min = '0';
                discountInput.max = '100';
                discountInput.step = '1';
                discountInput.value = '0';
            } else if (discountType === 'fixed') {
                discountLabel.textContent = 'Discount Amount ($):';
                discountInput.min = '0';
                discountInput.max = '';
                discountInput.step = '0.01';
                discountInput.value = '0';
            }
            
            discountRow.style.display = discountType === 'none' ? 'none' : 'block';
            calculateTotals();
        }

        // Add event listener to discount type select
        document.getElementById('discountType').addEventListener('change', updateDiscountInput);

        // Add event listener to update the display text when milestone description changes
        document.getElementById('milestoneInput').addEventListener('input', function(e) {
            document.getElementById('milestoneDisplay').textContent = e.target.value || 'at 50% project completion';
        });

        function updatePaymentSchedule() {
            const scheduleType = document.getElementById('paymentCount').value;
            const totalAmount = parseFloat(document.querySelector('[name="total"]').value) || 0;
            
            if (scheduleType === '3') { // Default 3 payments
                document.getElementById('defaultPayments').style.display = 'block';
                document.getElementById('customPayments').style.display = 'none';
                calculateDefaultPayments(totalAmount);
            } else {
                document.getElementById('defaultPayments').style.display = 'none';
                document.getElementById('customPayments').style.display = 'block';
                generateCustomPaymentFields(scheduleType, totalAmount);
            }
        }

        function calculateDefaultPayments(totalAmount) {
            document.querySelectorAll('#defaultPayments .payment-group').forEach(group => {
                const ratioInput = group.querySelector('.ratio');
                const amountInput = group.querySelector('.amount');
                const currentPercent = parseFloat(ratioInput.value) || 0;
                
                // Always use current input value for calculations
                const calculatedAmount = (totalAmount * currentPercent / 100).toFixed(2);
                amountInput.value = calculatedAmount;
                
                // Update the original reference for validation
                ratioInput.dataset.original = currentPercent;
            });
        }

        function generateCustomPaymentFields(numberOfPayments, totalAmount) {
            const container = document.getElementById('customPayments');
            container.innerHTML = `
                <div id="customPercentageWarning" style="color: #e74c3c; display: none; margin: 10px 0;">
                    ⚠️ Total percentages must add up to exactly 100%
                </div>
            `;

            for (let i = 1; i <= numberOfPayments; i++) {
                const paymentHTML = `
                    <div class="payment-group">
                        <h4>Payment ${i}</h4>
                        <div class="payment-row">
                            <input type="number" class="ratio" placeholder="Percentage" 
                                   min="0" max="100" step="1" 
                                   oninput="validateCustomPayments()">
                            <span>%</span>
                            <input type="number" class="amount" readonly>
                            <input type="text" class="description" placeholder="Payment description">
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', paymentHTML);
            }
        }

        function validateCustomPayments() {
            const inputs = [...document.querySelectorAll('#customPayments .ratio')];
            const warning = document.getElementById('customPercentageWarning');
            
            const totalPercent = inputs.reduce((sum, input) => 
                sum + (parseFloat(input.value) || 0), 0);
            
            if (totalPercent !== 100) {
                warning.style.display = 'block';
                inputs.forEach(input => {
                    input.style.borderColor = '#e74c3c';
                    input.setCustomValidity('Invalid');
                });
            } else {
                warning.style.display = 'none';
                inputs.forEach(input => {
                    input.style.borderColor = '#ddd';
                    input.setCustomValidity('');
                });
            }
            
            // Update amounts even if invalid
            const totalAmount = parseFloat(document.querySelector('[name="total"]').value) || 0;
            inputs.forEach(input => {
                const percent = parseFloat(input.value) || 0;
                const amount = totalAmount * percent / 100;
                input.parentElement.querySelector('.amount').value = amount.toFixed(2);
            });
        }

        function updatePaymentCalculations(totalAmount) {
            const scheduleType = document.getElementById('paymentCount').value;
            
            if (scheduleType === '3') {
                calculateDefaultPayments(totalAmount);
            } else {
                document.querySelectorAll('#customPayments input[type="text"]').forEach(input => {
                    calculateCustomPayment(input, totalAmount);
                });
            }
        }

        // Update milestone display text
        function updateMilestoneDisplay(value) {
            document.getElementById('milestoneDisplay').textContent = value || 'at 50% project completion';
        }

        // Add these event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for discount inputs
            document.querySelector('[name="discountAmount"]').addEventListener('input', calculateTotals);
            document.getElementById('discountType').addEventListener('change', calculateTotals);
            document.getElementById('paymentMethod').addEventListener('change', calculateTotals);
            
            // Initial calculation
            calculateTotal();
        });

        // Update payment calculations for default schedule
        function updateDefaultPayments(input) {
            const ratios = [...document.querySelectorAll('#defaultPayments .ratio')];
            const totalPercent = ratios.reduce((sum, input) => sum + parseFloat(input.value || 0), 0);
            
            // Validate total percentage
            const warning = document.getElementById('percentageWarning');
            if (totalPercent !== 100) {
                warning.style.display = 'block';
                // Check if the element supports setCustomValidity before calling it
                if (input && typeof input.setCustomValidity === 'function') {
                    input.setCustomValidity('Invalid');
                }
                ratios.forEach(r => r.style.borderColor = '#e74c3c');
            } else {
                warning.style.display = 'none';
                ratios.forEach(r => {
                    if (typeof r.setCustomValidity === 'function') {
                        r.setCustomValidity('');
                    }
                    r.style.borderColor = '#ddd';
                });
            }
            
            // Update amounts even if invalid, but show warning
            const totalAmount = parseFloat(document.querySelector('[name="total"]').value) || 0;
            ratios.forEach(input => {
                const percent = parseFloat(input.value) || 0;
                const amount = totalAmount * percent / 100;
                input.parentElement.querySelector('.amount').value = amount.toFixed(2);
            });
        }

        // Reset to original values if invalid
        document.getElementById('paymentCount').addEventListener('change', function() {
            if (this.value === '3') {
                const ratios = [...document.querySelectorAll('#defaultPayments .ratio')];
                const totalPercent = ratios.reduce((sum, input) => sum + parseFloat(input.value || 0), 0);
                
                if (totalPercent !== 100) {
                    ratios.forEach(input => {
                        // Reset to last valid input instead of original default
                        const lastValid = parseFloat(input.dataset.original) || input.value;
                        input.value = lastValid;
                    });
                    calculateTotals(); // Force recalculation with valid values
                }
            }
        });

        // Add this validation function
        function validatePaymentsBeforePDF() {
            const paymentType = document.getElementById('paymentCount').value;
            let totalPercent = 0;
            
            if (paymentType === '3') {
                const ratios = [...document.querySelectorAll('#defaultPayments .ratio')];
                totalPercent = ratios.reduce((sum, input) => sum + parseFloat(input.value || 0), 0);
            } else {
                const inputs = [...document.querySelectorAll('#customPayments .ratio')];
                totalPercent = inputs.reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            }

            if (totalPercent !== 100) {
                alert('Payment percentages must total exactly 100%');
                return false;
            }
            return true;
        }

        // Add these event listeners to ensure real-time updates
        document.addEventListener('DOMContentLoaded', function() {
            // Update default payments when any ratio changes
            document.querySelectorAll('#defaultPayments .ratio').forEach(input => {
                input.addEventListener('input', function() {
                    calculateTotals();
                    updateDefaultPayments(parseFloat(document.querySelector('[name="total"]').value) || 0);
                });
            });

            // Update custom payments when any ratio changes
            document.querySelectorAll('#customPayments').forEach(container => {
                container.addEventListener('input', function() {
                    calculateTotals();
                });
            });
        });

        // Update the DOMContentLoaded event handler for loading estimate data
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in edit mode - only load data if explicitly editing
            const isEditMode = sessionStorage.getItem('isEditingEstimate') === 'true';
            
            if (!isEditMode) {
                // Clear any stored data to prevent accidental loading
                sessionStorage.removeItem('editEstimateData');
                localStorage.removeItem('editEstimateData');
                console.log('Creating new estimate - starting with blank form');
                return; // Exit early - don't load any data
            }
            
            // We're in edit mode, try to get edit data from both storage locations
            let editData = null;
            try {
                const sessionData = sessionStorage.getItem('editEstimateData');
                const localData = localStorage.getItem('editEstimateData');
                
                // Use sessionStorage data if available, otherwise try localStorage
                if (sessionData) {
                    editData = JSON.parse(sessionData);
                    console.log('Loaded edit data from sessionStorage');
                } else if (localData) {
                    editData = JSON.parse(localData);
                    console.log('Loaded edit data from localStorage');
                }
            } catch (e) {
                console.error('Error parsing saved estimate data:', e);
            }
            
            // If we have edit data, fill the form
            if (editData) {
                console.log('Populating form with edit data:', editData);
                
                // Basic fields
                document.querySelector('[name="estimateNumber"]').value = editData.estimate_number || '';
                document.querySelector('[name="clientName"]').value = editData.client_name || '';
                document.querySelector('[name="clientEmail"]').value = editData.client_email || '';
                document.querySelector('[name="clientPhone"]').value = editData.client_phone || '';
                document.querySelector('[name="projectDescription"]').value = editData.project_description || '';
                
                // Address - need to parse from combined field
                if (editData.client_address) {
                    const addressParts = editData.client_address.split(',');
                    if (addressParts.length >= 2) {
                        document.querySelector('[name="clientStreet"]').value = addressParts[0].trim();
                        
                        // The second part might contain city and postal code
                        const cityPostalParts = addressParts[1].trim().split(' ');
                        if (cityPostalParts.length >= 2) {
                            // First part is city, rest is postal code (which might be multiple words)
                            document.querySelector('[name="clientCity"]').value = cityPostalParts[0].trim();
                            document.querySelector('[name="clientPostal"]').value = cityPostalParts.slice(1).join(' ').trim();
                        } else {
                            document.querySelector('[name="clientCity"]').value = cityPostalParts[0] || '';
                        }
                    }
                }
                
                // Separate postal code if available
                if (editData.client_postal) {
                    document.querySelector('[name="clientPostal"]').value = editData.client_postal;
                }
                
                // Set amounts
                if (editData.subtotal) document.querySelector('[name="subtotal"]').value = editData.subtotal;
                if (editData.tax) document.querySelector('[name="tax"]').value = editData.tax;
                if (editData.total) document.querySelector('[name="total"]').value = editData.total;
                
                // Set payment method
                if (editData.payment_method) {
                    document.getElementById('paymentMethod').value = editData.payment_method;
                }
                
                // Set discount
                if (editData.discount_type) {
                    document.getElementById('discountType').value = editData.discount_type;
                    document.querySelector('[name="discountAmount"]').value = editData.discount_amount || '0';
                    document.querySelector('[name="afterDiscount"]').value = editData.after_discount || '0';
                    updateDiscountInput(); // Make sure this function exists in your code
                }
                
                // Load line items
                if (editData.line_items && Array.isArray(editData.line_items)) {
                    // Fix the line items loading code
                    const lineItemsContainer = document.getElementById('lineItems');
                    const templateRow = lineItemsContainer.querySelector('tr');
                    
                    // Clone the template row instead of manipulating the HTML directly
                    if (templateRow) {
                        // Clear existing rows except the template
                        while (lineItemsContainer.children.length > 1) {
                            lineItemsContainer.removeChild(lineItemsContainer.lastChild);
                        }
                        
                        // Add rows for each line item
                        editData.line_items.forEach(item => {
                            // Clone the template row instead of calling addLineItem
                            const newRow = templateRow.cloneNode(true);
                            
                            // Fill in the fields
                            if (newRow) {
                                newRow.querySelector('.item-desc').value = item.description || '';
                                newRow.querySelector('.quantity').value = item.quantity || '';
                                newRow.querySelector('.rate').value = item.unit_price || '';
                                
                                // Calculate the amount
                                const qty = parseFloat(item.quantity) || 0;
                                const rate = parseFloat(item.unit_price) || 0;
                                const amount = qty * rate;
                                
                                // Update amount display
                                newRow.querySelector('.item-total').textContent = amount.toFixed(2);
                                
                                // Add the new row to the container
                                lineItemsContainer.appendChild(newRow);
                            }
                        });
                    }
                    
                    // Trigger total recalculation
                    calculateTotal();
                }
                
                // Update the title
                document.querySelector('h1').textContent = 'Edit Estimate';
                document.querySelector('button[type="submit"]').textContent = 'Update Estimate';
                
                // Clear the edit mode flag and stored data
                sessionStorage.removeItem('isEditingEstimate');
                sessionStorage.removeItem('editEstimateData');
                localStorage.removeItem('editEstimateData');
            }
        });
    </script>
</body>
</html>